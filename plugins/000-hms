#!/usr/bin/env bash
# mid: HMS clock with blinking separators (robust)
set -euo pipefail

# capture any runtime errors so you can inspect them
OUT_LOG="${HOME}/.cache/seasoning/000-hms.err"
mkdir -p "$(dirname "$OUT_LOG")"
exec 2>"$OUT_LOG"

# --- per-output mode state ---
OUT="${WAYBAR_OUTPUT_NAME:-$(/usr/bin/seasoning which-output 2>/dev/null || echo default)}"
CACHE="${SEASONING_CACHE:-$HOME/.cache/seasoning}/$OUT"
MODE_FILE="$CACHE/mode.000-hms.state"
mkdir -p "$CACHE"

mode=0
if [[ -r "$MODE_FILE" ]]; then
  read -r m <"$MODE_FILE" || true
  [[ "${m:-}" =~ ^[0-9]+$ ]] && mode=$(( m % 4 ))
fi

# --- time fields (avoid process substitution to be extra safe) ---
H="$(date +%H)"; M="$(date +%M)"; S="$(date +%S)"
sec=$((10#$S))

blink(){ # $1=even-glyph $2=odd-glyph
  if (( sec & 1 )); then printf '%s' "${2:- }"; else printf '%s' "${1:-:}"; fi
}

txt=""
case "$mode" in
  0) txt="${H}$(blink ":" ".")${M}" ;;
  1) txt="${H}$(blink " " "·")${M}" ;;
  2) txt="${H}:${M}:${S}" ;;
  3) txt="${H}·${M}·${S}" ;;
  *) txt="${H}!${M}" ;;
esac

printf '{"text":"%s","class":"mid--000-hms"}\n' "$txt"
